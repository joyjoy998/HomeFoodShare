<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Food Item</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      form {
        display: flex;
        flex-direction: column;
      }
      label {
        margin-top: 10px;
      }
      input,
      textarea,
      select {
        padding: 5px;
        margin-top: 5px;
      }
      button {
        margin-top: 20px;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }
      .image-preview {
        display: flex;
        flex-wrap: wrap;
        margin-top: 20px;
      }
      .image-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin-right: 10px;
        margin-bottom: 10px;
        overflow: hidden;
      }
      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .image-container button {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Upload Food Details</h2>
    <form id="uploadForm">
      <label for="photo">Photo:</label>
      <input type="file" id="photo" accept="image/*" multiple /><br /><br />

      <div id="imagePreview" class="image-preview"></div>

      <label for="tags">Cuisine Type:</label>
      <select id="tags" required>
        <option value="">Select a cuisine type</option>
        <option value="Chinese">Chinese</option>
        <option value="Italian">Italian</option>
        <option value="Japanese">Japanese</option>
        <option value="Indian">Indian</option>
        <option value="French">French</option>
        <option value="Mexican">Mexican</option>
        <option value="Thai">Thai</option>
        <option value="Mediterranean">Mediterranean</option>
        <option value="American">American</option>
        <option value="Korean">Korean</option>
        <option value="Vietnamese">Vietnamese</option>
        <option value="Middle Eastern">Middle Eastern</option>
        <option value="African">African</option>
        <option value="Spanish">Spanish</option>
        <option value="Greek">Greek</option>
        <option value="Others">Others</option>
      </select>
      <br /><br />

      <label for="code">Address Code (Australian Postcode):</label>
      <input
        type="text"
        id="code"
        placeholder="Enter Australian postcode"
        required /><br />
      <span id="postcodeError" class="error-message" style="display: none"
        >Invalid postcode. Please enter a 4-digit Australian postcode.</span
      ><br />

      <label for="description">Description:</label>
      <textarea
        id="description"
        placeholder="Describe the food..."
        required></textarea>
      <br /><br />

      <button type="submit">Upload</button>
    </form>

    <script>
      let imagesArray = [];

      document
        .getElementById("photo")
        .addEventListener("change", function (event) {
          const files = event.target.files;

          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function (e) {
              const imageUrl = e.target.result;
              imagesArray.push({ file, imageUrl });
              displayImages();
            };

            reader.readAsDataURL(file);
          }
        });

      function displayImages() {
        const imagePreview = document.getElementById("imagePreview");
        imagePreview.innerHTML = "";

        imagesArray.forEach((image, index) => {
          const imageContainer = document.createElement("div");
          imageContainer.classList.add("image-container");

          const imgElement = document.createElement("img");
          imgElement.src = image.imageUrl;

          const deleteButton = document.createElement("button");
          deleteButton.innerText = "X";
          deleteButton.addEventListener("click", () => {
            removeImage(index);
          });

          imageContainer.appendChild(imgElement);
          imageContainer.appendChild(deleteButton);
          imagePreview.appendChild(imageContainer);
        });
      }

      function removeImage(index) {
        imagesArray.splice(index, 1);
        displayImages();
      }

      // Validate Australian postcode (4-digit number)
      function validatePostcode(postcode) {
        const regex = /^[0-9]{4}$/;
        return regex.test(postcode);
      }

      document.getElementById("code").addEventListener("input", function () {
        const postcode = this.value;
        const errorElement = document.getElementById("postcodeError");

        if (!validatePostcode(postcode)) {
          errorElement.style.display = "block";
        } else {
          errorElement.style.display = "none";
        }
      });

      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const postcode = document.getElementById("code").value;
          const description = document.getElementById("description").value;
          const tags = document.getElementById("tags").value;
          const errorElement = document.getElementById("postcodeError");

          // Check if at least one image is uploaded
          if (imagesArray.length === 0) {
            alert("Please upload at least one image.");
            return;
          }

          // Check if description is empty
          if (description.trim() === "") {
            alert("Description cannot be empty.");
            return;
          }

          // Validate postcode
          if (!validatePostcode(postcode)) {
            errorElement.style.display = "block";
            return;
          }

          // Construct JSON data
          const jsonData = {
            tags: tags,
            description: description,
            code: postcode,
          };

          // Log the JSON data to the console
          console.log("Constructed JSON data:", JSON.stringify(jsonData));

          const formData = new FormData();
          formData.append("data", JSON.stringify(jsonData)); // Append JSON data

          // Convert images to Base64
          const imagePromises = imagesArray.map((image) => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(image.file); // Convert image to Base64
            });
          });

          Promise.all(imagePromises)
            .then((base64Images) => {
              // Construct JSON data
              const jsonData = {
                tags: tags,
                description: description,
                code: postcode,
                images: base64Images, // Base64 encoded images
              };

              // Send JSON data to Lambda function
              fetch(
                "https://lprm7x82w9.execute-api.ap-southeast-2.amazonaws.com/post",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json", // Send JSON
                  },
                  body: JSON.stringify(jsonData), // Convert JSON to string
                }
              )
                .then((response) => response.json())
                .then((data) => {
                  console.log("Response data:", data); // Debug: Log response data
                  if (data.success) {
                    alert("Food item uploaded successfully");
                    document.getElementById("uploadForm").reset();
                    imagesArray = [];
                    displayImages();
                  } else {
                    alert(
                      "Upload failed: " + (data.message || "Unknown error")
                    );
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert("Upload failed due to a network or server error.");
                });
            })
            .catch((error) => {
              console.error("Error converting images to Base64:", error);
            });
        });
    </script>
  </body>
</html>
